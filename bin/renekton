#!/usr/bin/env node
const version = require('../package.json').version;
const path = require('path');
const figlet = require('figlet');
const printer = require('@darkobits/lolcatjs').default;
const program = require('commander');
const inquirer = require('inquirer');
const chalk = require('chalk');
const json2ts = require('json2ts');
const ora = require('ora');
const shell = require('shelljs');
const download = require('download-git-repo');
const templateUrl = 'direct:https://github.com/RenektonChr/demo.git';

const txt = figlet.textSync('Renekton CLI') + "\n" + "renekton è„šæ‰‹æ¶" + version;
const result = printer.fromString(txt);

program.version(result, "-v, --version");
program.option('init', 'ğŸ¶ åˆå§‹åŒ–é¡¹ç›®...');
program.option('json2ts', 'ğŸ† å°†RDçš„æ¥å£ç”ŸæˆTS...');

const bindHandler = {
  init(parms) {
    inquirer
      .prompt([
        {
          type: 'text',
          name: 'dirname',
          message: 'ğŸ“ è¯·è¾“å…¥é¡¹ç›®åç§°'
        },
        {
          type: 'list',
          name: 'jskind',
          message: "ğŸ’¼ è¯·é€‰æ‹©è¯¥é¡¹ç›®è¯­è¨€",
          choices: [
            "âœ” ES6", "âœ” TypeScript", "âœ” CoffeeScript"
          ]
        }
      ])
      .then(answers => {
        // Use user feedback for... whatever!!
        /**
         * 1. gitå‡†å¤‡ä¸€ä¸ªå¯æ‰©å±•æ€§å¼ºçš„é¡¹ç›®
         * 2. gitä¸‹è½½å“ªä¸€ä¸ªåŒ…
         * 3. shelljsæ ¹æ®ç”¨æˆ·çš„é€‰æ‹©å¯¹ä½ ä¸‹è½½çš„åŒ…è¿›è¡Œåˆ é™¤å’Œä¿®æ”¹
         * 4. åœ¨ç”¨æˆ·çš„é¡¹ç›®ç›®å½•æƒ³åˆ›å»ºé¡¹ç›®
         * 5. å¼•å¯¼ç”¨æˆ·å¼€å‘ä½¿ç”¨
         */

        const _dirname = answers.dirname;
        if (_dirname) {
          const spinner = ora('â°download templateÂ·Â·Â·');
          spinner.start();
          const _pwd = shell.pwd().stdout;
          const _projectPath = path.join(_pwd, `/${_dirname}`);
          shell.cd(_pwd);
          shell.rm('-rf', _projectPath);
          shell.mkdir(_dirname);
          download(templateUrl, _projectPath, { 'clone': true }, function(err) {
            spinner.stop();
            if(err) {
              // ä¸‹è½½å¤±è´¥ä¹‹åæç¤ºï¼Œå¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚
              console.log(chalk.red('ğŸ§â€â™‚ï¸ å¾ˆé—æ†¾ï¼Œæ¨¡æ¿ä¸‹è½½å¤±è´¥ï¼'));
              console.log(err.message);
            }else {
              shell.sed("-i", "demo", _dirname, _projectPath + "/package.json");
              // ä¸‹è½½æˆåŠŸåï¼Œç»™ç”¨æˆ·åé¦ˆ
              console.log('download success!\n\n\n');
              console.log(chalk.blue(`cd ${_dirname}`));
              console.log(chalk.blue(`npm install`));
              console.log(chalk.blue(`npm start(ğŸ˜” ç›¸åº”çš„è„šæ‰‹æ¶å‘½ä»¤è¿˜åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...)`));
            }
          });
        }
      })
      .catch(error => {
        if (error.isTtyError) {
          // Prompt couldn't be rendered in the current environment
        } else {
          // Something else went wrong
        }
      });
  },
  json2ts(jsonurl) {
    console.log('æ¥å£åœ°å€ï¼š', jsonurl);
    const spinner = ora('â° æ­£åœ¨ç”Ÿæˆä»£ç ï¼Œè¯·ç¨åÂ·Â·Â·');
    spinner.start();
    const contentJson = {
      code: 1,
      info: {
        message: 'è¯·æ±‚æˆåŠŸ',
        data: [
          {
            num: '1',
            title: '3å·ä»“åº“'
          }
        ]
      }
    };
    const result = json2ts.convert(JSON.stringify(contentJson));
    console.log(result);
    spinner.stop();
  }
};

program.usage("<cmd> [env]")
  .arguments("<cmd> [env]")
  .action(function (cmd, otherParms) {
    const handler = bindHandler[cmd];
    if (handler) {
      handler(otherParms);
    } else {
      // console.log("æš‚æœªå®ç°" + cmd);
      console.log(chalk.yellow("ğŸ™ éå¸¸é—æ†¾") + "ã€" + chalk.red(cmd) + "ã€‘" + chalk.yellow("æ²¡æœ‰å®ç°Â·Â·Â·"));
    }
  });

program.parse(process.argv);

// console.log(result);
